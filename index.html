<!doctype html>
<html>
	<head>
		<title>Pitch Detector</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link href='https://fonts.googleapis.com/css?family=Alike' rel='stylesheet' type='text/css'>
		<style>
			* {
				box-sizing: border-box;
			}

			html, body {
				height: 100%;
				margin: 0;
			}

			body {
				font: 14pt 'Alike', sans-serif;
				padding: 20px;
				background-color: #f5f5f5;
				display: flex;
				flex-direction: column;
			}

			.container {
				flex: 1;
				display: flex;
				flex-direction: column;
				max-width: 1200px;
				width: 100%;
				margin: 0 auto;
			}

			h1 {
				text-align: center;
				color: #333;
				margin: 0 0 15px 0;
				font-size: 1.8rem;
				flex-shrink: 0;
			}

			.controls {
				display: flex;
				flex-wrap: wrap;
				gap: 15px;
				justify-content: center;
				align-items: center;
				margin-bottom: 15px;
				flex-shrink: 0;
			}

			#stopButton {
				padding: 12px 32px;
				font-size: 16px;
				font-family: 'Alike', sans-serif;
				background-color: #e74c3c;
				color: white;
				border: none;
				border-radius: 6px;
				cursor: pointer;
				transition: background-color 0.2s;
				display: none;
			}

			#stopButton:hover {
				background-color: #c0392b;
			}

			#stopButton:active {
				background-color: #a93226;
			}

			#instrument {
				padding: 12px 16px;
				font-size: 16px;
				font-family: 'Alike', sans-serif;
				border: 2px solid #ddd;
				border-radius: 6px;
				background-color: white;
				cursor: pointer;
			}

			#instrument:focus {
				outline: none;
				border-color: #4CAF50;
			}

			.tuning-toggle-container {
				display: flex;
				align-items: center;
				gap: 10px;
				font-size: 14px;
				margin-top: 20px;
				padding-top: 15px;
				border-top: 1px solid #ddd;
			}

			.toggle-switch {
				position: relative;
				display: inline-block;
				width: 50px;
				height: 26px;
			}

			.toggle-switch input {
				opacity: 0;
				width: 0;
				height: 0;
			}

			.toggle-slider {
				position: absolute;
				cursor: pointer;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background-color: #ccc;
				transition: 0.3s;
				border-radius: 26px;
			}

			.toggle-slider:before {
				position: absolute;
				content: "";
				height: 18px;
				width: 18px;
				left: 4px;
				bottom: 4px;
				background-color: white;
				transition: 0.3s;
				border-radius: 50%;
			}

			input:checked + .toggle-slider {
				background-color: #4CAF50;
			}

			input:checked + .toggle-slider:before {
				transform: translateX(24px);
			}

			.main-display {
				flex: 1;
				display: flex;
				gap: 20px;
				min-height: 0;
			}

			#detector {
				flex: 1;
				background-color: white;
				border: 4px solid #ddd;
				border-radius: 12px;
				text-align: center;
				padding: 20px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
				display: flex;
				flex-direction: column;
				justify-content: center;
				align-items: center;
				min-width: 0;
				transition: background-color 0.2s ease;
			}

			#detector.confident {
				border-color: #4CAF50;
			}

			#detector.vague {
				border-color: #ddd;
			}

			/* Background colors now applied dynamically via JavaScript */
			#detector.flat {
				/* background-color set dynamically */
			}

			#detector.sharp {
				/* background-color set dynamically */
			}

			div.confident {
				color: black;
			}

			div.vague {
				color: #ccc;
			}

			.pitch {
				font-size: 18px;
				color: #666;
				margin-bottom: 10px;
			}

			#pitch {
				font-size: clamp(20px, 3vw, 28px);
				font-weight: bold;
				color: #333;
			}

			#note {
				font-size: clamp(60px, 15vw, 140px);
				line-height: 1.1;
				display: block;
				margin: 10px 0;
			}

			#detune {
				font-size: clamp(14px, 2vw, 18px);
				color: #666;
				min-height: 30px;
			}

			#detune_amt {
				font-weight: bold;
				color: #333;
			}

			#flat, #sharp {
				display: none;
			}

			.flat #flat {
				display: inline;
				color: #e74c3c;
			}

			.sharp #sharp {
				display: inline;
				color: #3498db;
			}

			.canvas-container {
				flex: 2;
				background-color: white;
				border-radius: 12px;
				padding: 10px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
				display: flex;
				align-items: center;
				justify-content: center;
				min-width: 0;
				overflow: hidden;
			}

			#vexflow-output {
				width: 100%;
				height: 100%;
				display: flex;
				align-items: center;
				justify-content: center;
			}

			#vexflow-output svg {
				display: block;
				max-width: 100%;
				max-height: 100%;
			}

			.droptarget {
				background-color: #348781;
			}

			/* ===== Tutorial Overlay ===== */
			#tutorial-overlay {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.65);
				backdrop-filter: blur(4px);
				-webkit-backdrop-filter: blur(4px);
				z-index: 1000;
				pointer-events: all;
				opacity: 1;
				transition: opacity 0.4s ease;
			}

			#tutorial-overlay.tutorial-hiding {
				opacity: 0;
				pointer-events: none;
			}

			/* Title visible above overlay */
			body.tutorial-step-1 h1,
			body.tutorial-step-2 h1 {
				position: relative;
				z-index: 1001;
				background: #f5f5f5;
				padding: 6px 24px;
				border-radius: 10px;
			}

			/* Controls visible above overlay */
			body.tutorial-step-1 .controls,
			body.tutorial-step-2 .controls {
				position: relative;
				z-index: 1001;
				background: #f5f5f5;
				padding: 12px 24px;
				border-radius: 12px;
				box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
			}

			/* Nav links visible above overlay in step 2 */
			body.tutorial-step-2 .nav-links {
				position: relative;
				z-index: 1001;
				background: #f5f5f5;
				padding: 4px 16px;
				border-radius: 8px;
			}

			/* Pulse animation on instrument select during step 1 */
			body.tutorial-step-1 #instrument {
				animation: tutorial-pulse 2s ease-in-out infinite;
			}

			@keyframes tutorial-pulse {
				0%, 100% {
					border-color: #ddd;
					box-shadow: none;
				}
				50% {
					border-color: #4CAF50;
					box-shadow: 0 0 0 4px rgba(76, 175, 80, 0.3);
				}
			}

			/* Tooltip bubble */
			.tutorial-bubble {
				position: fixed;
				background: white;
				border-radius: 14px;
				padding: 18px 22px;
				max-width: 320px;
				min-width: 220px;
				box-shadow: 0 8px 32px rgba(0, 0, 0, 0.35);
				z-index: 1002;
				text-align: center;
				line-height: 1.6;
				font-size: 15px;
				pointer-events: none;
			}

			.tutorial-bubble strong {
				display: block;
				margin-bottom: 8px;
				font-size: 17px;
				color: #222;
			}

			.tutorial-bubble p {
				margin: 6px 0;
				color: #444;
			}

			.tutorial-bubble a {
				color: #4CAF50;
				font-weight: bold;
				text-decoration: none;
				pointer-events: all;
			}

			.tutorial-bubble a:hover {
				text-decoration: underline;
			}

			/* Arrow pointing up toward element above the bubble */
			.bubble-arrow-up {
				position: absolute;
				top: -11px;
				left: 50%;
				transform: translateX(-50%);
				width: 0;
				height: 0;
				border-left: 11px solid transparent;
				border-right: 11px solid transparent;
				border-bottom: 11px solid white;
			}

			/* Skip button */
			#tutorial-skip {
				position: fixed;
				bottom: 28px;
				right: 28px;
				z-index: 1002;
				background: transparent;
				color: rgba(255, 255, 255, 0.75);
				border: 1px solid rgba(255, 255, 255, 0.4);
				border-radius: 20px;
				padding: 8px 18px;
				cursor: pointer;
				font-size: 13px;
				font-family: 'Alike', sans-serif;
				letter-spacing: 0.3px;
				transition: color 0.2s, border-color 0.2s, background 0.2s;
			}

			#tutorial-skip:hover {
				color: white;
				border-color: rgba(255, 255, 255, 0.8);
				background: rgba(255, 255, 255, 0.1);
			}

			/* Mobile styles */
			@media (max-width: 700px) {
				body {
					padding: 10px;
				}

				h1 {
					font-size: 1.4rem;
					margin-bottom: 10px;
				}

				.controls {
					flex-direction: column;
					gap: 10px;
					margin-bottom: 10px;
				}

				#stopButton,
				#instrument {
					width: 100%;
					max-width: 280px;
				}

				.main-display {
					flex-direction: column;
				}

				#detector {
					flex: none;
					min-height: 180px;
				}

				.canvas-container {
					flex: 1;
					min-height: 220px;
				}
			}
		</style>
	</head>
	<body>
		<script src="https://unpkg.com/vexflow@3.0.9/releases/vexflow-min.js"></script>
		<script src="js/pitchdetect.js"></script>

		<div class="container">
			<h1>Pitch Detector</h1>
			<div class="nav-links" style="text-align: center; margin-bottom: 15px;">
				<a href="note-trainer.html" style="color: #4CAF50; text-decoration: none; font-size: 14px;">Go to Note Trainer</a>
			</div>

			<div class="controls">
				<select name="Instrument" id="instrument">
					<option value="">Select an instrument to begin</option>
					<option value="treble clef">Treble Clef</option>
					<option value="bass clef">Bass Clef</option>
					<option value="flute">Flute</option>
					<option value="oboe">Oboe</option>
					<option value="clarinet">Clarinet</option>
					<option value="bass clarinet">Bass Clarinet</option>
					<option value="bassoon">Bassoon</option>
					<option value="alto sax">Alto Sax</option>
					<option value="tenor sax">Tenor Sax</option>
					<option value="bari sax">Bari Sax</option>
					<option value="trumpet">Trumpet</option>
					<option value="horn">Horn</option>
					<option value="trombone">Trombone</option>
					<option value="euphonium">Euphonium</option>
					<option value="tuba">Tuba</option>
					<option value="glockenspiel">Glockenspiel</option>
				</select>
				<button id="stopButton" onclick="stopPitchDetect();">Stop</button>
			</div>

			<div class="main-display">
				<div id="detector" class="vague">
					<div class="pitch"><span id="pitch">--</span> Hz</div>
					<span id="note">--</span>
					<div id="detune">
						<span id="detune_amt">--</span>
						<span id="flat">cents &#9837;</span>
						<span id="sharp">cents &#9839;</span>
					</div>
					<div class="tuning-toggle-container">
						<label for="tuningToggle">Color Tuner:</label>
						<label class="toggle-switch">
							<input type="checkbox" id="tuningToggle">
							<span class="toggle-slider"></span>
						</label>
					</div>
				</div>

				<div class="canvas-container">
					<div id="vexflow-output"></div>
				</div>
			</div>
		</div>

	<!-- Tutorial Overlay -->
	<div id="tutorial-overlay" style="display:none">
		<!-- Step 1: Select an instrument -->
		<div id="tutorial-bubble-1" class="tutorial-bubble">
			<strong>Welcome to Pitch Detector!</strong>
			<p>Select your instrument from the dropdown above to get started.</p>
			<div class="bubble-arrow-up"></div>
		</div>

		<!-- Step 2: Play a note or go to Note Trainer -->
		<div id="tutorial-bubble-2" class="tutorial-bubble" style="display:none">
			<strong>Ready to go!</strong>
			<p>Play a note on your instrument &mdash; detection starts automatically.</p>
			<p>Or <a href="note-trainer.html" id="tutorial-trainer-link">open Note Trainer</a> to place a note on the staff.</p>
			<div class="bubble-arrow-up"></div>
		</div>

		<button id="tutorial-skip">Skip tutorial &times;</button>
	</div>

	<script>
	// ===== Tutorial System =====
	(function() {
		var STORAGE_KEY = 'pitchdetect-tutorial-done';
		var tutorialStep = 0;
		var overlay, bubble1, bubble2;

		function tryStorage(fn) {
			try { return fn(); } catch (e) { return null; }
		}

		function positionBubble(bubble, anchorEl) {
			var rect = anchorEl.getBoundingClientRect();
			var bubbleW = bubble.offsetWidth || 280;

			// Place bubble below the anchor
			var top = rect.bottom + 20;
			var targetCenter = rect.left + rect.width / 2;
			var left = targetCenter - bubbleW / 2;

			// Keep within viewport horizontally with padding
			left = Math.max(16, Math.min(left, window.innerWidth - bubbleW - 16));

			bubble.style.top = top + 'px';
			bubble.style.left = left + 'px';

			// Shift the arrow so it points at the anchor's center
			var arrow = bubble.querySelector('.bubble-arrow-up');
			if (arrow) {
				var arrowPos = (targetCenter - left) - 11;
				arrowPos = Math.max(12, Math.min(arrowPos, bubbleW - 24));
				arrow.style.left = arrowPos + 'px';
				arrow.style.transform = 'none';
			}
		}

		function showStep1() {
			tutorialStep = 1;
			window.tutorialStep = 1;
			document.body.classList.add('tutorial-step-1');
			overlay.style.display = 'block';
			bubble1.style.display = 'block';
			bubble2.style.display = 'none';

			requestAnimationFrame(function() {
				var controls = document.querySelector('.controls');
				if (controls) positionBubble(bubble1, controls);
			});
		}

		function showStep2() {
			tutorialStep = 2;
			window.tutorialStep = 2;
			document.body.classList.remove('tutorial-step-1');
			document.body.classList.add('tutorial-step-2');
			bubble1.style.display = 'none';
			bubble2.style.display = 'block';

			// Initial position (Stop button not yet visible â€” getUserMedia is async)
			requestAnimationFrame(function() {
				var controls = document.querySelector('.controls');
				if (controls) positionBubble(bubble2, controls);
			});

			// Reposition once the Stop button appears (controls grows taller after mic grant)
			var stopBtn = document.getElementById('stopButton');
			if (stopBtn) {
				var stopObserver = new MutationObserver(function() {
					stopObserver.disconnect();
					requestAnimationFrame(function() {
						if (tutorialStep === 2) {
							var controls = document.querySelector('.controls');
							if (controls) positionBubble(bubble2, controls);
						}
					});
				});
				stopObserver.observe(stopBtn, { attributes: true, attributeFilter: ['style'] });
			}
		}

		window.closeTutorial = function() {
			if (tutorialStep === 0) return;
			tutorialStep = 0;
			window.tutorialStep = 0;
			document.body.classList.remove('tutorial-step-1', 'tutorial-step-2');
			overlay.classList.add('tutorial-hiding');
			setTimeout(function() {
				overlay.style.display = 'none';
				overlay.classList.remove('tutorial-hiding');
			}, 400);
			tryStorage(function() {
				localStorage.setItem(STORAGE_KEY, 'true');
			});
		};

		document.addEventListener('DOMContentLoaded', function() {
			// Skip if tutorial already completed
			if (tryStorage(function() { return localStorage.getItem(STORAGE_KEY); }) === 'true') return;

			overlay = document.getElementById('tutorial-overlay');
			bubble1 = document.getElementById('tutorial-bubble-1');
			bubble2 = document.getElementById('tutorial-bubble-2');
			if (!overlay || !bubble1 || !bubble2) return;

			showStep1();

			// Advance to step 2 when an instrument is chosen
			var instrumentSelect = document.getElementById('instrument');
			if (instrumentSelect) {
				instrumentSelect.addEventListener('change', function() {
					if (tutorialStep === 1 && instrumentSelect.value !== '') {
						showStep2();
					}
				});
			}

			// Skip button dismisses the tutorial
			var skipBtn = document.getElementById('tutorial-skip');
			if (skipBtn) {
				skipBtn.addEventListener('click', window.closeTutorial);
			}

			// Mark tutorial done if navigating to Note Trainer via any link
			document.querySelectorAll('a[href="note-trainer.html"]').forEach(function(link) {
				link.addEventListener('click', function() {
					tryStorage(function() {
						localStorage.setItem(STORAGE_KEY, 'true');
					});
				});
			});

			// Reposition bubbles if the window is resized
			window.addEventListener('resize', function() {
				var controls = document.querySelector('.controls');
				if (!controls) return;
				if (tutorialStep === 1) positionBubble(bubble1, controls);
				else if (tutorialStep === 2) positionBubble(bubble2, controls);
			});
		});
	})();
	</script>
	</body>
</html>
